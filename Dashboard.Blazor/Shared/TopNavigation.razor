@using System.Security.Claims;
<!--begin::Header-->
<div id="kt_app_header" class="app-header d-flex flex-column flex-stack">
    <!--begin::Header main-->
    <div class="d-flex align-items-center flex-stack flex-grow-1">
        <div class="app-header-logo d-flex align-items-center justify-content-around flex-stack px-lg-11 mb-2" id="kt_app_header_logo">
            <!--begin::Sidebar mobile toggle-->
            <div class="btn btn-icon btn-active-color-primary w-35px h-35px ms-3 me-2 d-flex d-lg-none" id="kt_app_sidebar_mobile_toggle">
                <i class="ki-duotone ki-abstract-14 fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </div>
            <!--end::Sidebar mobile toggle-->
            <!--begin::Logo-->
            <a href="/" class="app-sidebar-logo">
                <img src="images/LogoWord.png" class="h-60px h-md-80px py-5" />
            </a>
            <!--end::Logo-->
            <!--begin::Sidebar toggle-->
            <div id="kt_app_sidebar_toggle" class="app-sidebar-toggle btn btn-sm btn-icon btn-color-success me-n2 d-none d-lg-flex" data-kt-toggle="true" data-kt-toggle-state="active" data-kt-toggle-target="body" data-kt-toggle-name="app-sidebar-minimize">
                <i class="ki-duotone ki-exit-left fs-2x rotate-180">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </div>
            <!--end::Sidebar toggle-->
        </div>
        <!--begin::Navbar-->
        <div class="app-navbar flex-grow-1 justify-content-end" id="kt_app_header_navbar">
            <!--begin::User menu-->
            <div class="app-navbar-item ms-3 ms-lg-4 me-lg-2" id="kt_header_user_menu_toggle">
                <!--begin::Menu wrapper-->
                <div class="cursor-pointer symbol symbol-30px symbol-lg-40px" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-@(CurrentCulture == "ar-EG" ? "start" : "end")">
                    <img src="assets/media/avatars/300-2.jpg" alt="user" />
                </div>
                <!--begin::User account menu-->
                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg menu-state-color fw-semibold py-4 fs-6 w-275px" data-kt-menu="true">
                    <!--begin::Menu item-->
                    <div class="menu-item px-3">
                        <div class="menu-content d-flex align-items-center px-3">
                            <!--begin::Avatar-->
                            <div class="symbol symbol-75px @(CurrentCulture == "ar-EG" ? "ms-3" : "me-5")">
                                <img alt="Logo" src="assets/media/avatars/300-2.jpg" />
                            </div>
                            <!--end::Avatar-->
                            <!--begin::Username-->
                            <div class="fw-bold d-flex align-items-center flex-wrap fs-5">
                                <span class="py-1">
                                    Sweepy Admin
                                </span>
                                <a class="fw-semibold text-muted text-hover-primary fs-7">@claims.FirstOrDefault(x => x.Type == ClaimTypes.Email)?.Value</a>
                                <span class="badge badge-light-success fw-bold fs-8 py-1 px-2 mt-3">
                                    @claims.FirstOrDefault(x => x.Type == ClaimTypes.Role)?.Value
                                </span>
                            </div>
                            <!--end::Username-->
                        </div>
                    </div>
                    <!--end::Menu item-->
                    <!--begin::Menu separator-->
                    <div class="separator my-2"></div>
                    <!--end::Menu separator-->
                    <!--begin::Menu item-->
                    <div class="menu-item px-5">
                        <a href="../dist/account/overview.html" class="menu-link px-5">@languageContainer.Keys["MyProfile"]</a>
                    </div>
                    <!--end::Menu item-->
                    <!--begin::Menu separator-->
                    <div class="separator my-2"></div>
                    <!--end::Menu separator-->
                    <!--begin::Menu item-->
                    <div class="menu-item px-5" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-placement="left-start" data-kt-menu-offset="-15px, 0">
                        <a href="#" class="menu-link px-5">
                            <span class="menu-title position-relative">
                                @languageContainer.Keys["Mode"]
                                <span class="position-absolute translate-middle-y top-50 end-0" style=@(CurrentCulture == "ar-EG" ? "direction:ltr;" : string.Empty)>
                                    <i class="ki-duotone ki-night-day theme-light-show fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                        <span class="path4"></span>
                                        <span class="path5"></span>
                                        <span class="path6"></span>
                                        <span class="path7"></span>
                                        <span class="path8"></span>
                                        <span class="path9"></span>
                                        <span class="path10"></span>
                                    </i>
                                    <i class="ki-duotone ki-moon theme-dark-show fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                </span>
                            </span>
                        </a>
                        <!--begin::Menu-->
                        <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-title-gray-700 menu-icon-gray-500 menu-active-bg menu-state-color fw-semibold py-4 fs-base w-150px" data-kt-menu="true" data-kt-element="theme-mode-menu">
                            <!--begin::Menu item-->
                            <div class="menu-item px-3 my-0">
                                <a @onclick="ChangeThemeAsync" href="#" class="menu-link px-3 py-2" data-kt-element="mode" data-kt-value="light">
                                    <span class="menu-icon" data-kt-element="icon">
                                        <i class="ki-duotone ki-night-day fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                            <span class="path6"></span>
                                            <span class="path7"></span>
                                            <span class="path8"></span>
                                            <span class="path9"></span>
                                            <span class="path10"></span>
                                        </i>
                                    </span>
                                    <span class="menu-title">@languageContainer.Keys["Light"]</span>
                                </a>
                            </div>
                            <!--end::Menu item-->
                            <!--begin::Menu item-->
                            <div class="menu-item px-3 my-0">
                                <a @onclick="ChangeThemeAsync" href="#" class="menu-link px-3 py-2" data-kt-element="mode" data-kt-value="dark">
                                    <span class="menu-icon" data-kt-element="icon">
                                        <i class="ki-duotone ki-moon fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </span>
                                    <span class="menu-title">@languageContainer.Keys["Dark"]</span>
                                </a>
                            </div>
                            <!--end::Menu item-->
                        </div>
                        <!--end::Menu-->
                    </div>
                    <!--end::Menu item-->
                    <!--begin::Menu item-->
                    <div class="menu-item px-5" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-placement="left-start" data-kt-menu-offset="-15px, 0">
                        <a href="#" class="menu-link px-5">
                            <span class="menu-title position-relative">
                                @languageContainer.Keys["Language"]
                                <span class="fs-8 rounded position-absolute translate-middle-y top-50 end-0" style=@(CurrentCulture == "ar-EG" ? "direction:ltr;" : string.Empty)>
                                    @(CurrentCulture == "ar-EG" ? "عربي" : "English")
                                    <img class="w-15px h-15px rounded-1 ms-2" src="assets/media/flags/@(CurrentCulture == "ar-EG" ? "saudi-arabia.svg" : "united-states.svg")" alt="" />
                                </span>
                            </span>
                        </a>
                        <!--begin::Menu sub-->
                        <div class="menu-sub menu-sub-dropdown w-175px py-4">
                            <!--begin::Menu item-->
                            <div class="menu-item px-3">
                                <a @onclick='()=>SetLanguage("en-US")' class="menu-link d-flex px-5 @(CurrentCulture == "ar-EG" ? string.Empty : "active")">
                                    <span class="symbol symbol-20px me-4">
                                        <img class="rounded-1" src="assets/media/flags/united-states.svg" alt="" />
                                    </span>
                                    English
                                </a>
                            </div>
                            <!--end::Menu item-->
                            <!--begin::Menu item-->
                            <div class="menu-item px-3">
                                <a style="font-family: 'Noto Sans Arabic', sans-serif;" @onclick='()=>SetLanguage("ar-EG")' class="menu-link d-flex px-5 @(CurrentCulture == "ar-EG" ? "active" : string.Empty)">
                                    <span class="symbol symbol-20px me-4">
                                        <img class="rounded-1" src="assets/media/flags/saudi-arabia.svg" alt="" />
                                    </span>
                                    عربي
                                </a>
                            </div>
                            <!--end::Menu item-->
                        </div>
                        <!--end::Menu sub-->
                    </div>
                    <!--end::Menu item-->
                    <!--begin::Menu item-->
                    <div class="menu-item px-5 my-1">
                        <a @onclick="ShowAccountSettingsAsync" class="menu-link px-5">@languageContainer.Keys["Account Settings"]</a>
                    </div>
                    <!--end::Menu item-->
                    <!--begin::Menu item-->
                    <div class="menu-item px-5">
                        <a @onclick="SignOut" class="menu-link px-5">@languageContainer.Keys["Logout"]</a>
                    </div>
                    <!--end::Menu item-->
                </div>
                <!--end::User account menu-->
                <!--end::Menu wrapper-->
            </div>
            <!--end::User menu-->
            <!--begin::Action-->
            <div class="d-none d-md-inline app-navbar-item ms-3 ms-lg-4 me-lg-6">
                <!--begin::Link-->
                <a @onclick="ToggleFullScreen" class="btn btn-icon btn-custom btn-color-gray-600 btn-active-color-primary w-35px h-35px w-md-40px h-md-40px">
                    <i class="@(fullScreen ? "fa-solid fa-compress fs-2" : "fa-solid fa-expand fs-2")"></i>
                </a>
                <!--end::Link-->
            </div>
            <!--end::Action-->
            <!--begin::Header menu toggle-->
            <div class="app-navbar-item ms-3 ms-lg-4 ms-n2 me-3 d-flex d-lg-none">
                <div class="btn btn-icon btn-custom btn-color-gray-600 btn-active-color-primary w-35px h-35px w-md-40px h-md-40px" id="kt_app_aside_mobile_toggle">
                    <i class="ki-duotone ki-burger-menu-2 fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                        <span class="path5"></span>
                        <span class="path6"></span>
                        <span class="path7"></span>
                        <span class="path8"></span>
                        <span class="path9"></span>
                        <span class="path10"></span>
                    </i>
                </div>
            </div>
            <!--end::Header menu toggle-->
        </div>
        <!--end::Navbar-->
    </div>
    <!--end::Header main-->
    <!--begin::Separator-->
    <div class="app-header-separator"></div>
    <!--end::Separator-->
</div>
<!--end::Header-->
@code {
    [Inject] IJSRuntime JSRuntime { get; set; } = default!;
    [Inject] ILanguageContainerService LangContainer { get; set; } = default!;
    [Inject] ILocalStorageService LocalStorage { get; set; } = default!;
    [Inject] AuthenticationStateProvider AuthStateProvider { get; set; } = default!;
    [Inject] NavigationManager NavManager { get; set; } = default!;
    [Inject] IDialogService DialogService { get; set; } = default!;

    [Parameter][EditorRequired] public string CurrentCulture { get; set; } = string.Empty;
    [Parameter][EditorRequired] public EventCallback ThemeChnaged { get; set; }

    private bool fullScreen = false;
    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    protected override async Task OnInitializedAsync()
    {
        claims = await GetClaimsPrincipalData();
    }

    private async Task ToggleFullScreen()
    {
        await JSRuntime.InvokeVoidAsync("FullScreen");

        fullScreen = !fullScreen;
    }

    private async Task ChangeThemeAsync()
    {
        await ThemeChnaged.InvokeAsync();
    }

    private void SetLanguage(string cultureCode)
    {
        LangContainer.SetLanguage(CultureInfo.GetCultureInfo(cultureCode));
        if (CultureInfo.CurrentCulture != null)
        {
            // Set the culture in LocalStorage
            LocalStorage.SetItemAsync("CurrentCulture", cultureCode);
            // Load the Current URL
            NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
        }
    }

    private async Task SignOut()
    {
        await LocalStorage.RemoveItemAsync("token");
        await AuthStateProvider.GetAuthenticationStateAsync();
    }

    private async Task ShowAccountSettingsAsync()
    {
        DialogOptions dialogOptions = new()
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                Position = DialogPosition.TopCenter,
                CloseButton = true,
            };

        await DialogService.ShowAsync<AccountSettings>("Account Settings", dialogOptions);
    }

    private async Task<IEnumerable<Claim>> GetClaimsPrincipalData()
    {
        var authState = await AuthStateProvider
            .GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            foreach (var item in user.Claims)
            {
                Console.WriteLine(item);
            }
            return user.Claims;
        }

        return Enumerable.Empty<Claim>();
    }


}