@inherits BasePage
@attribute [Authorize]

<MudDialog>
    <DialogContent>
        <div class="mt-5">
            <h3 class="text-dark fw-bold mb-7">@languageContainer.Keys["Authenticator App"]</h3>
            <!--begin::Description-->
            <div class="text-gray-500 fw-semibold fs-6 mb-5">
                @languageContainer.Keys["Use the authenticator app"]
                <a href="https://support.google.com/accounts/answer/1066447?hl=en" target="_blank">Google Authenticator, </a>
                @languageContainer.Keys["scan the QR code and It will generate a 6 digit code for you"]
                <!--begin::QR code image-->
                <div class="d-flex flex-wrap align-items-center justify-content-center">
                    <!-- Google Play Store App Link -->
                    <div class="p-3">
                        <a class="app-link rounded-circle" href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en_US" target="_blank">
                            <img src="assets/media/logos/playstore-download.png" alt="Google Play Store" class="w-150px">
                        </a>
                    </div>
                    <!-- Apple App Store App Link -->
                    <div class="p-3">
                        <a class="app-link rounded-circle" href="https://apps.apple.com/us/app/google-authenticator/id388497605" target="_blank">
                            <img src="assets/media/logos/applestore-download.png" alt="Apple App Store" class="w-150px">
                        </a>
                    </div>
                </div>
                <div class="pt-5 d-flex justify-content-center w-100">
                    @if (twoFactorAuth is not null)
                    {
                        <img src="@twoFactorAuth.QrCodeImage" alt="" class="mw-200px">
                    }
                    else
                    {
                        <MudSkeleton Animation="Animation.Wave" SkeletonType="SkeletonType.Rectangle" Width="180px" Height="180px" />
                    }
                </div>
                <!--end::QR code image-->
            </div>
            <!--end::Description-->
            <!--begin::Notice-->
            <div class="notice d-flex bg-light-warning rounded border-warning border border-dashed p-6">
                <!--begin::Icon-->
                <i class="ki-duotone ki-information fs-2tx text-warning me-4"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
                <!--end::Icon-->
                <!--begin::Wrapper-->
                <div class="d-flex flex-stack flex-grow-1 ">
                    <!--begin::Content-->
                    <div class=" fw-semibold">
                        <div class="fs-6 text-gray-700 ">
                            @languageContainer.Keys["If you having trouble using the QR code, select manual entry on your app, and enter the code"]:
                            <br />
                            <div style="line-break:anywhere" class="fw-bold text-gray-900 pt-2">
                                @(twoFactorAuth is null ? "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" : twoFactorAuth.SecretKey)
                            </div>
                        </div>
                    </div>
                    <!--end::Content-->
                </div>
                <!--end::Wrapper-->
            </div>
            <!--end::Notice-->
            <div class="d-flex flex-center mt-5">
                <button @onclick="CallBackDisableTwoFactorAuth" class="btn btn-warning">
                    <span class="indicator-label">
                        @languageContainer.Keys["Disable Two-Factor Authentication"]
                    </span>
                </button>
            </div>
        </div>
    </DialogContent>
    <DialogActions>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter][EditorRequired] public string userId { set; get; } = null!;

    private TwoFactorAuthDto? twoFactorAuth;

    protected override async Task OnParametersSetAsync()
    {
        var result = await PostAsync<TwoFactorAuthDto>
            ($"Account/EnableOrDisableTwoFactor?userId={userId}&enable={true}", showSuccess: false);

        var twoFactorAuthInfo = result.obj;

        if (twoFactorAuthInfo is not null)
        {
            twoFactorAuth = twoFactorAuthInfo;
            twoFactorAuth.isTwoFactorEnabled = true;
        }
    }

    private void CallBackDisableTwoFactorAuth()
    {
        MudDialog.Close();
    }
}
